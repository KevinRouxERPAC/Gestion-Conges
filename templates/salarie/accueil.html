{% extends "base.html" %}
{% block title %}Mes congés{% endblock %}

{% block content %}
<div class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">Bonjour {{ current_user.prenom }} !</h1>
        <p class="text-gray-500 mt-1">Voici le récapitulatif de vos congés</p>
    </div>
    <div class="flex flex-row items-center gap-3 md:gap-4 justify-between w-full flex-nowrap">
        <!-- Bouton principal : à gauche -->
        <a href="{{ url_for('salarie.demander_conge') }}"
           class="inline-flex items-center justify-center bg-erpac-primary hover:bg-erpac-dark text-white font-semibold text-base md:text-lg py-3 md:py-3.5 px-6 md:px-8 rounded-xl transition shadow-lg whitespace-nowrap shrink-0">
            + Demander un congé
        </a>
        <!-- Boutons d'export : groupés à droite -->
        <div class="flex items-center gap-2 shrink-0">
            <a href="{{ url_for('salarie.export_excel') }}"
               class="inline-flex items-center justify-center px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs md:text-sm font-medium rounded-lg transition border border-gray-300 whitespace-nowrap">
                Export Excel
            </a>
            <a href="{{ url_for('salarie.export_pdf') }}"
               class="inline-flex items-center justify-center px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs md:text-sm font-medium rounded-lg transition border border-gray-300 whitespace-nowrap">
                Export PDF
            </a>
        </div>
    </div>
</div>

{% set conges_valides = conges|selectattr('statut', 'equalto', 'valide')|list %}
{% set total_cp_pris = conges_valides|selectattr('type_conge', 'equalto', 'CP')|map(attribute='nb_jours_ouvrables')|sum %}
{% set total_anc_pris = conges_valides|selectattr('type_conge', 'equalto', 'Anciennete')|map(attribute='nb_jours_ouvrables')|sum %}
{% set total_rtt_pris = conges_valides|selectattr('type_conge', 'equalto', 'RTT')|map(attribute='nb_jours_ouvrables')|sum %}
{% set cp_restants = solde.jours_conges - total_cp_pris %}
{% set anc_restants = solde.jours_anciennete - total_anc_pris %}
<!-- Solde -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow p-6">
        <div class="text-sm font-medium text-gray-500">Solde restant</div>
        <div class="text-4xl font-bold {% if solde.solde_restant <= 5 %}text-red-600{% elif solde.solde_restant <= 10 %}text-orange-500{% else %}text-green-600{% endif %} mt-1">
            {{ solde.solde_restant }}
        </div>
        <div class="text-xs text-gray-400 mt-1">
            Congés restants (CP / ancienneté) : {{ solde.solde_restant }}
            | RTT pris: {{ total_rtt_pris }}
        </div>
    </div>
    <div class="bg-white rounded-xl shadow p-6">
        <div class="text-sm font-medium text-gray-500">Total de congés alloués</div>
        <div class="text-3xl font-bold text-erpac-primary mt-1">{{ solde.total_alloue }}</div>
        <div class="text-xs text-gray-400 mt-1">
            Congés (CP / ancienneté / report) : {{ solde.jours_conges + solde.jours_anciennete + solde.jours_report }}
        </div>
    </div>
    <div class="bg-white rounded-xl shadow p-6">
        <div class="text-sm font-medium text-gray-500">Total consommé</div>
        <div class="text-3xl font-bold text-gray-700 mt-1">{{ solde.total_consomme }}</div>
        <div class="text-xs text-gray-400 mt-1">
            Congés : {{ total_cp_pris + total_anc_pris }} | RTT: {{ total_rtt_pris }}
        </div>
    </div>
</div>

<!-- Progress bar -->
<div class="bg-white rounded-xl shadow p-6 mb-8">
    <div class="flex justify-between text-sm text-gray-600 mb-2">
        <span>Consommation des congés</span>
        <span>{{ solde.total_consomme }} / {{ solde.total_alloue }} jour(s)</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-4">
        {% set pct = (solde.total_consomme / solde.total_alloue * 100) if solde.total_alloue > 0 else 0 %}
        <div id="progress-bar-fill" class="h-4 rounded-full transition-all duration-500 {{ 'bg-red-500' if pct > 90 else 'bg-orange-400' if pct > 70 else 'bg-erpac-primary' }}"
             data-width-pct="{{ pct|int }}"></div>
    </div>
</div>
<script>var el=document.getElementById('progress-bar-fill');if(el)el.style.width=el.getAttribute('data-width-pct')+'%';</script>

<!-- Conges list -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="px-6 py-4 border-b">
        <h2 class="text-lg font-semibold text-gray-800">Mes congés</h2>
    </div>
    {% if conges %}
    <table class="w-full">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Période</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jours</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Commentaire</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for conge in conges %}
            <tr class="hover:bg-gray-50 transition">
                <td class="px-6 py-4 text-sm">
                    {{ conge.date_debut.strftime('%d/%m/%Y') }} &rarr; {{ conge.date_fin.strftime('%d/%m/%Y') }}
                </td>
                <td class="px-6 py-4">
                    <span class="font-semibold">{{ conge.nb_jours_ouvrables }}</span>
                    <span class="text-gray-500 text-sm">jour(s)</span>
                </td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 rounded text-xs font-medium
                        {% if conge.type_conge == 'CP' %}bg-erpac-100 text-erpac-800
                        {% elif conge.type_conge == 'RTT' %}bg-purple-100 text-purple-800
                        {% elif conge.type_conge == 'Maladie' %}bg-red-100 text-red-800
                        {% elif conge.type_conge == 'Anciennete' %}bg-green-100 text-green-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ 'Congés' if conge.type_conge in ['CP', 'Anciennete'] else conge.type_conge }}
                    </span>
                </td>
                <td class="px-6 py-4">
                    {% if conge.statut == 'valide' %}
                    <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">Validé</span>
                    {% elif conge.statut == 'en_attente_responsable' %}
                    <span class="px-2 py-1 rounded text-xs font-medium bg-orange-100 text-orange-800">En attente responsable</span>
                    {% elif conge.statut == 'en_attente_rh' %}
                    <span class="px-2 py-1 rounded text-xs font-medium bg-amber-100 text-amber-800">En attente RH</span>
                    {% elif conge.statut == 'refuse' %}
                    <span class="px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800" title="{{ conge.motif_refus or '' }}">Refusé</span>
                    {% elif conge.statut == 'annule' %}
                    <span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">Annulé</span>
                    {% else %}
                    <span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">{{ conge.statut }}</span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">
                    {{ conge.motif_refus if conge.statut == 'refuse' and conge.motif_refus else (conge.commentaire or '-') }}
                </td>
                <td class="px-6 py-4 text-right">
                    {% if conge.statut in ['en_attente_responsable', 'en_attente_rh'] %}
                    <form method="POST" action="{{ url_for('salarie.annuler_conge', conge_id=conge.id) }}" class="inline" onsubmit="return confirm('Annuler cette demande ?')">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="text-red-600 hover:text-red-800 text-sm font-medium">Annuler</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="px-6 py-12 text-center text-gray-500">Aucun congé enregistré pour le moment.</div>
    {% endif %}
</div>
{% endblock %}
